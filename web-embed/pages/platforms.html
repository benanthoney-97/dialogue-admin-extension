<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SeedLegals | Platforms</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <div class="app-shell">
    <video-sidebar default-section="connections"></video-sidebar>
    <main>
      <section>
        <h2>Connected Platforms</h2>
        <sources-table></sources-table>
      </section>
    </main>
  </div>

  <script type="module" src="../components/sidebar/sidebar.js"></script>
  <script type="module" src="../components/sources-table/sources-table.js"></script>
  <script type="module" src="../components/right-panel/right-panel.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="../components/index/platforms.js"></script>
  <script>
    function handleSidebarSelect(event) {
      const section = event?.detail?.section || 'home';
      if (section === 'home') {
        window.location.href = '/pages/index.html';
      } else if (section === 'control') {
        window.location.href = '/pages/control.html';
      }
    }

    document.addEventListener('sidebar-select', handleSidebarSelect);
  </script>
  <div class="right-panel-shell" id="rightPanelShell">
    <right-panel></right-panel>
  </div>
  <script>
    const rightPanelShell = document.getElementById('rightPanelShell');
    const rightPanelEl = document.querySelector('right-panel');

    async function handleSourcesRowSelect(event) {
      if (!rightPanelEl || !rightPanelShell) return;
      const item = event.detail?.item || {};
      let docs = [];
      if (window.fetchProviderDocuments && item.provider_id) {
        docs = await window.fetchProviderDocuments(item.provider_id, item.url);
        console.log('provider_documents returned', docs.length, 'rows for', item.url);
      }

      if (!docs.length) {
        docs = [{
          name: item.name,
          url: item.url,
          type: item.type ?? 'platform'
        }];
      }

      const platformTitle = (item.name || item.platform_name) ? `${item.name || item.platform_name} content` : 'Content';
      rightPanelEl.headerTitle = platformTitle;

      rightPanelEl.data = docs.map(doc => ({
        id: doc.id,
        name: doc.title ?? doc.name ?? 'Untitled',
        url: doc.source_url ?? doc.url ?? '#',
        cover: doc.cover_image_url,
        active: Boolean(doc.is_active),
        type: doc.media_type ?? doc.type ?? 'document'
      }));
      rightPanelShell.classList.add('visible');
    }

    document.addEventListener('sources-row-select', handleSourcesRowSelect);

    document.addEventListener('click', (event) => {
      if (!rightPanelShell.contains(event.target)) {
        rightPanelShell.classList.remove('visible');
      }
    });

    rightPanelShell.addEventListener('click', (event) => {
      event.stopPropagation();
    });
  </script>
  <script type="module">
    import { updateDocumentActiveStatus } from '../components/index/platforms.js';

    document.addEventListener('right-panel-toggle', async (event) => {
      const item = event.detail?.item;
      if (!item?.id) return;
      try {
        await updateDocumentActiveStatus(item.id, Boolean(item.active));
        console.log('Updated document', item.id, 'is_active ->', item.active);
      } catch (error) {
        console.error('Unable to update document active state:', error);
      }
    });
  </script>
  <script src="../auto-reload.js"></script>
</body>
</html>
